name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm run build
        env:
          BASE_PATH: '/HemingResume/'

      - name: Verify build
        run: |
          echo "=== index.html 内容 ==="
          cat dist/index.html
          echo ""
          echo "=== 检查构建结果 ==="
          # 检查是否还有源码路径（构建失败的标志）
          if grep -qE '\.ts["\x27]|/src/' dist/index.html; then
            echo "❌ 错误: 发现未编译的源码路径"
            exit 1
          fi
          # 检查 base 路径是否正确
          if grep -q '/HemingResume/assets/' dist/index.html; then
            echo "✅ base 路径正确"
          else
            echo "❌ 错误: 未找到 /HemingResume/assets/ 路径"
            exit 1
          fi

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages
          force_orphan: true